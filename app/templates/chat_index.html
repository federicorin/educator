<!-- app/templates/chat_index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi Chat IA</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Ajustes rápidos */
    .sidebar { width: 250px; }
    .chat-window { flex: 1; }
    .message.user    { text-align: right; }
    .message.assistant { text-align: left; }
    .messages { max-height: 70vh; overflow-y: auto; }
/* Reset y configuración general */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Segoe UI", sans-serif;
  background-color: #242424;
  color: white;
  height: 100vh;
  display: flex;
  overflow: hidden;
}

/* ===== SIDEBAR ===== */
.sidebar {
  width: 270px;
  background-color: #161616;
  display: flex;
  flex-direction: column;
  padding: 1rem;
  transition: width 0.3s ease;
  overflow: hidden;
}

.sidebar.collapsed {
  width: 60px;
}

.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem;
  border-bottom: 1px solid #333;
}

.sidebar .logo {
  height: 32px;
  width: auto;
}

.toggle-menu-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: white;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: background 0.2s;
}

.toggle-menu-btn:hover {
  background-color: #444;
}

.section-title {
  margin: 1.2rem 0 0.5rem;
  font-size: 0.9rem;
  color: #aaaaaa;
}

.sidebar .top {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar button,
.sidebar input {
  width: 100%;
  margin-bottom: 10px;
  background-color: #2a2a2a;
  border: none;
  color: white;
  padding: 10px;
  border-radius: 8px;
}

/* Footer */
.sidebar footer {
  margin-top: auto;
  padding: 0.5rem 1rem;
  display: flex;
  justify-content: center;
  border-top: 1px solid #333;
}

/* Sidebar colapsada: centrado contenido y padding */
.sidebar.collapsed {
  width: 60px;
  align-items: center;
  padding: 1rem 0.5rem;
  overflow: visible; /* para que tooltips y menús no se corten */
}

/* Header en sidebar colapsada */
.sidebar.collapsed .sidebar-header {
  flex-direction: column;
  align-items: center;
  gap: 10px;
  padding: 1rem 0;
}

/* Logo margin */
.sidebar.collapsed .logo {
  margin-bottom: 0.5rem;
  height: 32px;
  width: 32px;
}

/* Quick icons y footer alineados */
.sidebar.collapsed .quick-icons,
.sidebar.collapsed footer {
  position: relative; /* para posicionar menú */
  width: 100%;
  display: flex;
  justify-content: center;
  padding: 10px 0;
}

/* Botones icon-btn visibles y con tamaño automático */
.sidebar.collapsed .icon-btn {
  width: auto;
  padding: 10px;
  font-size: 20px;
  text-align: center;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
}

.sidebar.collapsed .icon-btn span {
  display: none;
}

/* Perfil centrado en footer */
.sidebar.collapsed .profile {
  justify-content: center;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  text-align: center;
  cursor: pointer;
  padding: 10px 0;
}

/* Imagen de perfil */
.sidebar.collapsed .profile img {
  display: flex !important; /* asegurar que esté visible */
  cursor: pointer;
  width: 48px;
  height: 48px;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  gap: 4px;
}

/* Ocultar texto y menús innecesarios en colapsado */
.sidebar.collapsed .profile-name,
.sidebar.collapsed .profile-menu,
.sidebar.collapsed .section-title,
.sidebar.collapsed .chat-list-container,
.sidebar.collapsed .top > *:not(button):not(input),
.sidebar.collapsed input[type="text"] {
  display: none !important;
}

.sidebar.collapsed .profile-menu {
  display: none;
  position: absolute;
  bottom: 60px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  border-radius: 8px;
  padding: 8px;
  min-width: 140px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.7);
  flex-direction: column;
  z-index: 9999;
}

.sidebar.collapsed .profile-menu.show {
  display: flex !important;
}

.sidebar.collapsed .profile-menu button {
  background: none;
  border: none;
  color: white;
  padding: 8px 12px;
  cursor: pointer;
  text-align: left;
  border-radius: 4px;
  transition: background 0.2s;
}

/* Mantener visibles los botones + Nuevo chat y búsqueda en .top */
.sidebar.collapsed .top > button,
.sidebar.collapsed .top > input {
  display: block !important;
  width: 40px;
  height: 40px;
  padding: 0;
  margin: 5px 0;
  border-radius: 8px;
  font-size: 22px;
  text-align: center;
  cursor: pointer;
  background-color: #2a2a2a;
  color: white;
  border: none;
}

/* Input de búsqueda colapsado - solo icono (puedes poner un icono de lupa de fondo si quieres) */
.sidebar.collapsed .top > input {
  font-size: 0; /* ocultar texto placeholder */
  position: relative;
  background: url('data:image/svg+xml;utf8,<svg fill="white" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/></svg>') no-repeat center center;
  background-size: 16px 16px;
  cursor: pointer;
  padding: 10px;
}

/* Al enfocar input mostrar texto y expandir */
.sidebar.collapsed .top > input:focus {
  font-size: 14px;
  width: 100%;
  background: transparent;
  cursor: text;
}

/* Ajustes para los chat items y botones visibles en colapsado */
.sidebar.collapsed .chat-item {
  display: flex;
  justify-content: center;
  padding: 10px 0;
}

.sidebar.collapsed .chat-item .chat-title {
  display: none;
}

.sidebar.collapsed .chat-actions,
.sidebar.collapsed .chat-dots {
  display: none !important;
}

/* Scrollbar pequeño para chat-list si decides mostrar */
.chat-list-container::-webkit-scrollbar {
  width: 6px;
}

.chat-list-container::-webkit-scrollbar-thumb {
  background-color: #555;
  border-radius: 4px;
}

/* Mantener toggle button visible y usable */
.toggle-menu-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: white;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: background 0.2s;
}

.toggle-menu-btn:hover {
  background-color: #444;
}

/* Mantener el toggle visible y centrado también en colapsado */
.sidebar.collapsed .toggle-menu-btn {
  margin: 0 auto;
}

/* Tooltips para botones en sidebar colapsada */
.icon-btn[title],
.toggle-menu-btn[title],
.top > button[title],
.profile[title] {
  position: relative;
}

.icon-btn[title]:hover::after,
.toggle-menu-btn[title]:hover::after,
.top > button[title]:hover::after,
.profile[title]:hover::after {
  content: attr(title);
  position: absolute;
  left: 110%;
  top: 50%;
  transform: translateY(-50%);
  background: #222;
  padding: 5px 10px;
  border-radius: 6px;
  white-space: nowrap;
  z-index: 1000;
  font-size: 12px;
  color: white;
  pointer-events: none;
  opacity: 0.9;
  box-shadow: 0 0 5px rgba(0,0,0,0.5);
}


/* ===== PERFIL ===== */
.profile {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  padding: 10px;
  border-radius: 8px;
  transition: background 0.2s;
}

.profile:hover {
  background-color: #2c2c2c;
}

.profile img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background-color: #555;
}

.profile-name {
  font-size: 0.9rem;
}

.profile-menu {
  position: absolute;
  bottom: 60px;
  left: 10px;
  background-color: #2a2a2a;
  border: 1px solid #444;
  border-radius: 10px;
  padding: 10px;
  width: 200px;
  display: none;
  flex-direction: column;
  z-index: 100;
  align-items: center;
  gap: 0.5rem;
}

.profile-menu a {
  display: block;
  width: 100%;
  text-align: center;
  padding: 8px 12px;
  background: none;
  border: none;
  color: #f0f0f0;
  text-decoration: none;
  border-radius: 6px;
  font-size: 0.95rem;
  transition: background-color 0.2s, color 0.2s;
}

.profile-menu a:hover {
  background-color: #3a3a3a;
  color: #ffffff;
}

/* Opcional: eliminar el estilo azul al hacer focus */
.profile-menu button:focus {
  outline: none;
  box-shadow: none;
}


/* ===== CHAT LISTA ===== */
.chat-list-container {
  flex: 1;
  overflow-y: auto;
  padding-right: 5px;
  margin-bottom: 1rem;
}

.chat-list-container::-webkit-scrollbar {
  width: 6px;
}

.chat-list-container::-webkit-scrollbar-thumb {
  background-color: #555;
  border-radius: 4px;
}

.chat-list-container ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.chat-list-container li {
  padding: 8px 12px;
  border-radius: 8px;
  transition: background-color 0.2s;
  color: #e0e0e0;
  cursor: pointer;
  margin-bottom: 8px;
}

.chat-list-container li:hover {
  background-color: #2c2c2c;
}

.chat-list-container li.selected {
  background-color: #3a3a3a;
}

/* ===== ITEM CHAT ===== */
.chat-item {
  position: relative;
  display: flex;
  align-items: center;
  padding: 12px 16px;
  margin-bottom: 8px;
  border-radius: 8px;
  background-color: inherit;
  transition: background-color 0.2s;
}

.chat-item:hover,
.chat-item.selected {
  background-color: #2e2e2e;
}

.chat-title {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-right: 40px;
}

/* Botones */
.chat-dots {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  cursor: pointer;
  color: #aaa;
  transition: color 0.2s;
}

.chat-dots:hover {
  color: #fff;
}

.chat-actions {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  display: none;
  gap: 5px;
}

.chat-actions button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
  padding: 4px;
  border-radius: 4px;
  transition: background 0.2s;
  color: white;
}

.chat-actions button:hover {
  background-color: #444;
}

.chat-item:hover .chat-actions,
.chat-item.selected .chat-actions {
  display: flex;
}

.chat-item:hover .chat-dots,
.chat-item.selected .chat-dots {
  display: none;
}

/* ===== MAIN ===== */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 2rem;
}

.main h1 {
  font-size: 24px;
  margin-bottom: 2rem;
}

/* ===== INPUT AREA ===== */
.input-area {
  width: 60%;
  position: relative;
   max-width: 60%; 
}

.input-wrapper {
  background-color: #2c2c2c;
  border-radius: 10px;
  display: flex;
  align-items: center;
  padding: 10px;
  padding: 10px 60px 10px 60px;
  gap: 10px;
}

.input-wrapper textarea {
  display: block !important;    /* forzamos que se vea */
  flex: 1 !important;           /* ocupe todo el espacio disponible */  /* texto legible */
  line-height: 1.5em !important;
  color: white !important;      /* texto en blanco */
  background: transparent !important; /* fondo transparente (ya lo define .input-wrapper) */
  border: none !important;      /* sin borde extra */
  padding: 10px 0 !important;   /* un poco de espacio interno */
  overflow-y: auto;             /* scroll interno tras 7 líneas */
  min-height: 1.6em;         /* altura de 1 línea */
  max-height: calc(1.6em * 7 + 0,3); /* hasta 7 líneas */
  font-size: 18px !important;
  resize: none;    
}

.input-wrapper textarea::placeholder {
  color: #888 !important;
  opacity: 1; /* algunos navegadores bajan la opacidad por defecto */
}

.input-wrapper textarea:focus {
  outline: none;
}

.input-wrapper .attach-btn {
  width: auto !important;        /* que no ocupe todo */
  height: auto !important;
  padding: 6px !important;       /* tamaño cómodo para clic */
  position: absolute !important; /* lo sacamos del flow flex */
  left: 15px !important;         /* alineado a la izquierda */
  bottom: 15px !important;       /* alineado al bottom */
  background: none !important;   
  color: white !important;
  font-size: 20px !important;
  z-index: 2 !important;         /* encima del textarea */
}

/* Y como ya lo posicionamos, quitamos su margen interior en flex */
.input-wrapper {
  padding-left: 60px;            /* deja espacio al “+” */
}

.input-buttons {
  display: flex;
  align-items: center;
  gap: 10px;
}

.input-buttons button {
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

.send-btn {
  position: absolute;
  right: 15px;
  bottom: 15px;
  background-color: #444;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

/* ===== ICONOS RÁPIDOS ===== */
.quick-icons {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 1rem;
}

.icon-btn {
  width: 100%;
  padding: 10px;
  font-size: 18px;
  background: none;
  border: none;
  color: white;
  text-align: center;
  cursor: pointer;
}

.icon-btn:hover {
  background-color: #3a3a3a;
}

.file-upload-icon {
  position: absolute;
  left: 15px;
  bottom: 15px;
  background-color: #444;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  color: white;
  cursor: pointer;
  padding: 6px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.file-upload-icon:hover {
  background-color: #3a3a3a;
}

/* Ocultamos el input real */
.file-input-hidden {
  display: none;
}

.attach-menu {
  position: absolute;
  bottom: 60px;              /* ajusta según la altura del input */
  left: 50px;                /* ajusta la posición horizontal */
  background-color: #2a2a2a;
  border: 1px solid #444;
  border-radius: 8px;
  display: none;
  flex-direction: column;
  padding: 8px 0;
  z-index: 1000;
}

.attach-menu-item {
  background: none;
  border: none;
  color: #f0f0f0;
  padding: 8px 12px;
  width: 100%;
  text-align: left;
  cursor: pointer;
  font-size: 0.95rem;
  transition: background 0.2s;
}

.attach-menu-item:hover {
  background-color: #3a3a3a;
}

  textarea {
    resize: none;
    font-size: 16px;
    line-height: 1.5em;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #444;
    background: #333;
    color: white;
    max-height: calc(1.5em * 7 + 16px);
    overflow-y: auto;
  }

.chat-menu-container {
  position: relative;
  display: inline-block;
}

.menu-toggle-btn {
  background: none;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ccc;
  width: 28px;
  height: 28px;
  outline: none;          /* quita borde de foco (click) */
  box-shadow: none;       /* por si algún estilo le da sombra */
}

.menu-toggle-btn:hover,
.menu-toggle-btn:focus,
.menu-toggle-btn:active {
  background: none;
  outline: none;
  box-shadow: none;
}


.chat-dropdown-menu {
  position: absolute;
  top: 30px;
  right: 0;
  background-color: #2a2a2a;
  border: 1px solid #444;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  padding: 0.2rem;
  z-index: 100;
}

.chat-dropdown-menu button {
  display: block;
  width: 100%;
  background: none;
  border: none;
  color: #eee;
  text-align: center;
  cursor: pointer;
  font-size: 0.9rem;
  text-decoration: none;
  border-radius: 6px;
  font-size: 0.95rem;
}

.chat-dropdown-menu button:hover {
  background-color: #3a3a3a;
  color: #ffffff;
}

.hidden {
  display: none;
}

.sidebar:not(.collapsed) .sidebar-header {
  position: relative;
}

/* Posicionar el botón en la esquina superior derecha */
.sidebar:not(.collapsed) .toggle-menu-btn {
  position: absolute;
  top: 1rem;    /* ajusta a tu gusto */
  right: 1rem;  /* ajusta a tu gusto */
  width: auto;  /* que no se extienda a todo el ancho */
  padding: 4px; /* el padding que ya tenías */
}

.sidebar:not(.collapsed) .icon-btn span {
  font-size: 1rem;    /* o el valor que prefieras, ej. 1.2rem */
  margin-left: 0.5em; /* separa un poco del SVG */
  line-height: 1;     /* para que quede centrado con el icono */
  text-align: center;
}

.sidebar:not(.collapsed) .icon-btn {
  display: flex;                /* activa flexbox */
  align-items: center;          /* centra verticalmente */
  justify-content: center;      /* centra horizontalmente */
  gap: 0.5em;                   /* espacio entre icono y texto */
  padding: 0.5em 1em;           /* ajusta el padding a tu gusto */
}

/* Cuando el sidebar está colapsado: */
.sidebar.collapsed .new-session-btn,
.sidebar.collapsed .search-btn {
  width: auto;          /* Que no se estiren */
  padding: 8px;         /* Mantén solo algo de “click area” */
  text-indent: -9999px; /* Empuja cualquier texto (por si) fuera de la vista */
  display: flex;
  align-items: center;
  justify-content: center;
}


/* ==== RESPONSIVE: móvil (≤770px) ==== */
@media (max-width: 770px) {
  .main {
   justify-content: end !important;
  }

  .main h1 {
    height: 90%;
    position: relative;
  }

  .sidebar {
    display: none !important;
    position: fixed;
    top: 0; left: 0;
    height: 100vh;
    width: 250px;
    background-color: #161616;
    flex-direction: column;
    z-index: 1000;
    padding-top: 3.5rem;
  }
  .sidebar.show {
    display: flex !important;
  }

  /* Renombrado: mobile-toggle-btn */
  .mobile-toggle-btn {
    display: block !important;
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 1100;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: white;
    cursor: pointer;
  }

  .mobile-toggle-btn.hidden {
    display: none !important;
  }

  .input-area {
  width: 95%;
  position: relative;
  }
}

/* ===== FILE PREVIEWS ===== */
.file-previews-container {
    display: none; /* Por defecto, oculto */
    background-color: #2c2c2c;
    padding: 10px;
    border-radius: 10px 10px 0 0;
    border-bottom: 1px solid #444;
    gap: 10px;
    align-items: center;
    max-height: 120px;
    overflow-x: auto;
    white-space: nowrap; /* Evita que los elementos se envuelvan a la siguiente línea */
    width: 100%;
    width: 100%;
    max-width: 100%; 
    flex-wrap: nowrap;
}


.file-previews-container.active {
  display: flex;
  width: 100%; /* Esto es crucial para que no se salga de su padre */
  max-width: 100%; /* Una capa extra de seguridad */
  overflow-x: auto;
  white-space: nowrap;
}

.file-preview {
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: #3a3a3a;
    padding: 5px 10px;
    border-radius: 8px;
    color: white;
    font-size: 0.9em;
    position: relative;
    white-space: nowrap; /* Evita que el texto del nombre del archivo se rompa */
    flex-shrink: 0;
}

.file-preview .file-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: #fff;
}

.file-preview .file-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
}

.file-preview .remove-btn {
    background: none;
    border: none;
    color: #ff5555;
    font-size: 1.2em;
    cursor: pointer;
    line-height: 1;
}

  </style>
</head>
<body>

  <button class="mobile-toggle-btn" title="Mostrar / Ocultar menú" style="display: none;">
    ☰
  </button>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="{{ url_for('static', filename='img/logo_sidelbar.png') }}" alt="Logo" class="logo-fixed;">
      <button class="toggle-menu-btn" title="Mostrar / Ocultar menú">☰</button>
    </div>

<svg style="display: none;">
  <symbol id="icon-plus" viewBox="0 0 24 24">
    <path d="M12 5v14M5 12h14"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </symbol>
  <symbol id="icon-search" viewBox="0 0 24 24">
    <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"/>
    <line x1="16.5" y1="16.5" x2="21" y2="21"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </symbol>
</svg>

    <!-- Iconos rápidos visibles en modo colapsado -->
    <div class="quick-icons">
<button class="icon-btn new-session-btn" title="Nuevo chat">
  <svg width="20" height="20" aria-hidden="true">
    <use xlink:href="#icon-plus"/>
  </svg>
  <span class="sr-only">Nuevo chat</span>
</button>

<!-- Botón Buscar -->
<button id="searchBtn" class="icon-btn search-btn" title="Buscar">
  <svg width="20" height="20" aria-hidden="true">
    <use xlink:href="#icon-search"/>
  </svg>
  <span class="sr-only">Buscar</span>
</button>
    </div>

    <!-- Buscador -->
    <div id="searchContainer" style="display:none; margin: 8px;">
      <input type="text" id="searchInput" placeholder="Buscar chats..." style="width: 100%; padding: 4px;" />
      <ul id="searchResults" style="list-style:none; padding-left:0; max-height:150px; overflow-y:auto; margin-top:4px;"></ul>
    </div>

    <!-- Lista de Chats -->
    <div class="top">
      <div class="section-title">Chats</div>
      <div class="chat-list-container">
        <ul>
          {% for session in sessions %}
          <li class="chat-item {% if session.id == selected_session_id %}selected{% endif %}" data-session-id="{{ session.id }}">
            <span class="chat-title">{{ session.name or "Chat sin nombre" }}</span>
<div class="chat-menu-container">
  <button class="menu-toggle-btn" aria-label="Abrir menú">
    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon" aria-hidden="true"><path d="M15.498 8.50159C16.3254 8.50159 16.9959 9.17228 16.9961 9.99963C16.9961 10.8271 16.3256 11.4987 15.498 11.4987C14.6705 11.4987 14 10.8271 14 9.99963C14.0002 9.17228 14.6706 8.50159 15.498 8.50159Z"></path><path d="M4.49805 8.50159C5.32544 8.50159 5.99689 9.17228 5.99707 9.99963C5.99707 10.8271 5.32555 11.4987 4.49805 11.4987C3.67069 11.4985 3 10.827 3 9.99963C3.00018 9.17239 3.6708 8.50176 4.49805 8.50159Z"></path><path d="M10.0003 8.50159C10.8276 8.50176 11.4982 9.17239 11.4984 9.99963C11.4984 10.827 10.8277 11.4985 10.0003 11.4987C9.17283 11.4987 8.50131 10.8271 8.50131 9.99963C8.50149 9.17228 9.17294 8.50159 10.0003 8.50159Z"></path></svg>
  </button>
  <div class="chat-dropdown-menu hidden">
    <button class="rename-btn" data-session-id="{{ session.id }}">Renombrar</button>
    <button class="delete-btn" data-session-id="{{ session.id }}">Eliminar</button>
  </div>
</div>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Perfil en el footer -->
    <footer>
      <div class="profile" onclick="toggleProfileMenu()">
        <img src="https://ui-avatars.com/api/?name={{ full_name|replace(' ', '+') }}&background=555&color=fff" alt="avatar" />
        <div class="profile-name">{{ full_name }}</div>
      </div>

      <div class="profile-menu" id="profileMenu">
        <a href="#" id="memoriaBtn">🧠 Memoria</a>
        <a href="#" id="logoutBtn">🚪 Cerrar sesión</a>
      </div>
    </footer>
  </aside>

  <!-- Área principal -->
  <main class="main">
    <h1>¿En qué piensas hoy?</h1>

<!-- Input del usuario -->
    <div class="input-area">
      <div id="file-previews-container" class="file-previews-container"></div>
      <div class="input-wrapper">

  <!-- Preview de archivos seleccionados -->
  

  <!-- Input real oculto -->
  <input id="file-input" class="file-input-hidden" type="file" name="file" multiple/>
  <input type="file" id="file-input" name="file" class="file-input-hidden" multiple />

  <!-- Botón “+” para desplegar menú -->
  <button type="button" class="icon-btn attach-btn" title="Opciones">
    <!-- SVG de “+” -->
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>

  <!-- Mini-menú desplegable -->
  <div class="attach-menu" id="attachMenu">
    <button type="button" id="attachFileBtn" class="attach-menu-item">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M4.33496 12.5V7.5C4.33496 7.13273 4.63273 6.83496 5 6.83496C5.36727 6.83496 5.66504 7.13273 5.66504 7.5V12.5C5.66504 14.8942 7.60585 16.835 10 16.835C12.3942 16.835 14.335 14.8942 14.335 12.5V5.83301C14.3348 4.35959 13.1404 3.16522 11.667 3.16504C10.1934 3.16504 8.99822 4.35948 8.99805 5.83301V12.5C8.99805 13.0532 9.44679 13.502 10 13.502C10.5532 13.502 11.002 13.0532 11.002 12.5V7.5C11.002 7.13273 11.2997 6.83496 11.667 6.83496C12.0341 6.83514 12.332 7.13284 12.332 7.5V12.5C12.332 13.7877 11.2877 14.832 10 14.832C8.71226 14.832 7.66797 13.7877 7.66797 12.5V5.83301C7.66814 3.62494 9.45888 1.83496 11.667 1.83496C13.875 1.83514 15.6649 3.62505 15.665 5.83301V12.5C15.665 15.6287 13.1287 18.165 10 18.165C6.87131 18.165 4.33496 15.6287 4.33496 12.5Z"></path></svg> Adjuntar archivo
    </button>
    <button type="button" id="callMenuBtn" class="attach-menu-item">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M7.167 15.416V4.583a.75.75 0 0 1 1.5 0v10.833a.75.75 0 0 1-1.5 0Zm4.166-2.5V7.083a.75.75 0 0 1 1.5 0v5.833a.75.75 0 0 1-1.5 0ZM3 11.25V8.75a.75.75 0 0 1 1.5 0v2.5a.75.75 0 0 1-1.5 0Zm12.5 0V8.75a.75.75 0 0 1 1.5 0v2.5a.75.75 0 0 1-1.5 0Z"></path></svg> Llamada
    </button>
  </div>



  <!-- Textarea -->
  <textarea id="prompt" placeholder="Escribe tu mensaje aquí..."></textarea>

  <!-- Botón enviar -->
  <button class="send-btn" title="Enviar">↑</button>
</div>

    </div>
      </div>
    </div>
  </main>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // =======================
  // 👤 Prompt area
  // =======================
  const box = document.getElementById('messages-box');
  const fileInput = document.querySelector('.file-input');
  const attachBtn     = document.querySelector('.attach-btn');
  const attachMenu    = document.getElementById('attachMenu');
  const attachFileBtn = document.getElementById('attachFileBtn');
  const callMenuBtn   = document.getElementById('callMenuBtn');
  const promptArea = document.querySelector('.input-wrapper textarea');
 const toggleButtons = document.querySelectorAll(".menu-toggle-btn");

let filesArray = [];

if (promptArea) {
  const adjustHeight = () => {
    promptArea.style.height = 'auto';                // reset
    const h = Math.min(
      promptArea.scrollHeight,
      parseFloat(getComputedStyle(promptArea).lineHeight) * 7
    );
    promptArea.style.height = h + 'px';
  };

  // Ajustar al cargar contenido
  adjustHeight();

  // Ajustar en cada pulsación
  promptArea.addEventListener('input', adjustHeight);
}

// Mostrar/ocultar mini-menú
attachBtn.addEventListener('click', e => {
  e.stopPropagation();
  attachMenu.style.display = attachMenu.style.display === 'flex' ? 'none' : 'flex';
});

// Cerrar al hacer click fuera
window.addEventListener('click', e => {
  if (!attachBtn.contains(e.target) && !attachMenu.contains(e.target)) {
    attachMenu.style.display = 'none';
  }
});

// Opción “Adjuntar archivo”
attachFileBtn.addEventListener('click', () => {
  attachMenu.style.display = 'none';
  fileInput.click();
});

// Opción “Llamada”
callMenuBtn.addEventListener('click', () => {
  attachMenu.style.display = 'none';
  if (recognition && !recognizing) {
    recognition.start();
  }
  });

  
  function openModal() {
    document.getElementById('modal').classList.add('active');
  }

  function closeModal() {
    document.getElementById('modal').classList.remove('active');
  }


  const newChatBtn = document.querySelector('.icon-btn[title="Nuevo chat"]');
  if(newChatBtn){
    newChatBtn.addEventListener('click', () => {
     window.location.href = '/chat';
    });
  }
  

  // =======================
  // 👤 Search bar
  // =======================
const searchBtn = document.getElementById('searchBtn');
const searchContainer = document.getElementById('searchContainer');
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const chatListContainer = document.querySelector('.chat-list-container ul');

if (searchBtn && searchContainer && searchInput && searchResults && chatListContainer) {

  // Mostrar/ocultar contenedor búsqueda
  searchBtn.addEventListener('click', () => {
    if (searchContainer.style.display === 'none' || !searchContainer.style.display) {
      searchContainer.style.display = 'block';
      searchInput.focus();
    } else {
      searchContainer.style.display = 'none';
      searchInput.value = '';
      searchResults.innerHTML = '';
      chatListContainer.style.display = 'block';
    }
  });

  // Filtrar mientras escribís
  searchInput.addEventListener('input', () => {
    const q = searchInput.value.toLowerCase().trim();
    if (q === '') {
      searchResults.innerHTML = '';
      chatListContainer.style.display = 'block';
      return;
    }

    // Ocultar lista original
    chatListContainer.style.display = 'none';

    // Filtrar chats
    const matches = [];
    document.querySelectorAll('.chat-item').forEach(item => {
      const title = item.querySelector('.chat-title').textContent.toLowerCase();
      if (title.includes(q)) {
        matches.push({
          id: item.getAttribute('data-session-id'),
          name: item.querySelector('.chat-title').textContent
        });
      }
    });

    if (matches.length === 0) {
      searchResults.innerHTML = '<li>No se encontraron chats.</li>';
    } else {
      searchResults.innerHTML = matches.map(m => 
        `<li class="search-result-item" data-session-id="${m.id}" style="padding:4px; cursor:pointer; border-bottom:1px solid #ccc;">
          ${m.name}
        </li>`).join('');
    }
  });

  // Click en resultado para ir al chat
  searchResults.addEventListener('click', e => {
    const li = e.target.closest('.search-result-item');
    if (!li) return;
    const sessionId = li.getAttribute('data-session-id');
    if (sessionId) {
      window.location.href = `/chat/session/${sessionId}`;
    }
  });

}



  // =======================
  // 👤 Mostrar / ocultar menú de perfil
  // =======================
  const profile = document.querySelector(".profile");
  const profileMenu = document.getElementById("profileMenu");

  if (profile && profileMenu) {
    profile.addEventListener("click", (e) => {
      e.stopPropagation();
      profileMenu.style.display = profileMenu.style.display === "flex" ? "none" : "flex";
    });

    window.addEventListener("click", (e) => {
      if (!profile.contains(e.target) && !profileMenu.contains(e.target)) {
        profileMenu.style.display = "none";
      }
    });
  }

  // =======================
  // 🧠 Ir a la Memoria
  // =======================
  const memoriaBtn = document.getElementById("memoriaBtn");
  if (memoriaBtn) {
    memoriaBtn.addEventListener("click", (e) => {
      e.preventDefault();
      window.location.href = "/memory";  // Cambia a "/memoria" si tu ruta es esa
    });
  }

  // =======================
  // 🚪 Cerrar sesión
  // =======================
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      try {
        const res = await fetch("/logout", { method: "POST" });
        if (res.redirected) {
          window.location.href = res.url;
        } else {
          const data = await res.json();
          if (data.success) {
            window.location.href = "/login";
          } else {
            alert("No se pudo cerrar sesión.");
          }
        }
      } catch (err) {
        alert("Error de red al cerrar sesión.");
      }
    });
  }

  // =======================
  // ✏️ Renombrar chat
  // =======================
  document.querySelectorAll('.rename-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const sessionId = btn.getAttribute('data-session-id');
      const newName = prompt("Nuevo nombre para el chat:");
      if (newName) {
        const resp = await fetch(`/chat/session/${sessionId}/rename`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `name=${encodeURIComponent(newName)}`
        });
        const data = await resp.json();
        if (data.success) {
          const titleEl = btn.closest('.chat-item')?.querySelector('.chat-title');
          if (titleEl) titleEl.textContent = data.name;
        } else {
          alert("Error: " + (data.error || "desconocido"));
        }
      }
    });
  });

  // =======================
  // 🗑️ Eliminar chat
  // =======================
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!confirm("¿Eliminar este chat?")) return;
      const sessionId = btn.getAttribute('data-session-id');
      const resp = await fetch(`/chat/session/${sessionId}/delete`, { method: 'POST' });
      const data = await resp.json();
      if (data.success) {
        btn.closest('.chat-item')?.remove();
      } else {
        alert("Error al eliminar chat");
      }
    });
  });

  // =======================
  // ⋮ Menú de acciones de chat (.chat-dots)
  // =======================
  document.querySelectorAll('.chat-dots').forEach(dots => {
    dots.addEventListener('click', (e) => {
      e.stopPropagation();
      const item = dots.closest('.chat-item');

      // Cierra otros
      document.querySelectorAll('.chat-item.active').forEach(i => {
        if (i !== item) i.classList.remove('active');
      });

      // Alterna este
      if (item) item.classList.toggle('active');
    });
  });

  // Cierra todos los menús si haces clic fuera
  window.addEventListener('click', (e) => {
    if (!e.target.closest('.chat-item')) {
      document.querySelectorAll('.chat-item.active').forEach(i => i.classList.remove('active'));
    }
  });

  // =======================
  // ➕ Crear nuevo chat
  // =======================
async function createSessionAndRedirect(prompt) {
  try {
    const resp = await fetch("/chat/sessions", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "",  // Sin prompt
    });

    if (!resp.ok) {
      alert("Error al crear la sesión");
      return;
    }

    const data = await resp.json();
    const sessionUrl = data.session_url;

    // Redirigimos con el mensaje como parámetro
    const encodedPrompt = encodeURIComponent(prompt);
    window.location.href = `${sessionUrl}?initial_prompt=${encodedPrompt}`;

  } catch (error) {
    console.error("Error al crear sesión:", error);
    alert("Error al conectar con el servidor");
  }
}


  const sendBtn = document.querySelector(".send-btn");
  const promptInput = document.getElementById("prompt");

  // Enviar al presionar botón ↑
  if (sendBtn && promptInput) {
    sendBtn.addEventListener("click", () => {
      const prompt = promptInput.value.trim();
      if (prompt) {
        createSessionAndRedirect(prompt);
      }
    });

    // Enviar al presionar Enter (sin Shift)
    promptInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const prompt = promptInput.value.trim();
        if (prompt) {
          createSessionAndRedirect(prompt);
        }
      }
    });
  }

  // =======================
  // 📥 Colapsar/Expandir sidebar
  // =======================
  const sidebar = document.querySelector('.sidebar');
  const toggleBtn = document.querySelector('.toggle-menu-btn');
  if (sidebar && toggleBtn) {
    toggleBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sidebar.classList.toggle('collapsed');
      document.body.classList.toggle('sidebar-collapsed');
    });
  }

});

// =======================
// 📥 Redirigir al hacer clic en un chat-item
// =======================
document.querySelectorAll('.chat-item').forEach(item => {
  item.addEventListener('click', (e) => {
    // Evita que se dispare si estás haciendo clic en los íconos de editar/eliminar
    if (e.target.closest('.rename-btn') || e.target.closest('.delete-btn') || e.target.closest('.chat-dots')) {
      return;
    }

    const sessionId = item.getAttribute('data-session-id');
    if (sessionId) {
      window.location.href = `/chat/session/${sessionId}`;
    }
  });
});

// =======================
// 📥 Responsive
// =======================
  const sidebar         = document.querySelector('.sidebar');
  const mobileToggleBtn = document.querySelector('.mobile-toggle-btn');
  const toggleBtn       = document.querySelector('.toggle-menu-btn');
  const mainArea        = document.querySelector('.main');
  const mq              = window.matchMedia('(max-width: 770px)');

  function setupMobileHandlers() {
    // Solo registro handlers en responsive
    if (!mq.matches) return;

    // ——— BOTÓN MÓVIL (☰) ———
    mobileToggleBtn.addEventListener('click', e => {
      e.stopPropagation();
      sidebar.classList.toggle('show');
      sidebar.classList.remove('collapsed');
      document.body.classList.remove('sidebar-collapsed');
      mobileToggleBtn.classList.toggle('hidden', sidebar.classList.contains('show'));
    });

    // ——— BOTÓN TOGGLE DENTRO DEL SIDEBAR ———
    toggleBtn.addEventListener('click', e => {
      e.stopPropagation();
      // Como estamos en responsive, SOLO cerramos
      sidebar.classList.remove('show');
      mobileToggleBtn.classList.remove('hidden');
    });

    // ——— CLICK FUERA EN ÁREA PRINCIPAL ———
    mainArea.addEventListener('click', () => {
      if (sidebar.classList.contains('show')) {
        sidebar.classList.remove('show');
        mobileToggleBtn.classList.remove('hidden');
      }
    });
  }

  // Ejecutamos al inicio
  setupMobileHandlers();
  // Y volvemos a ejecutar si cambia el tamaño
  mq.addEventListener('change', setupMobileHandlers);

  // (el resto de tu código de mobileToggleBtn permanece igual)


    // --- 1. OBTENER ELEMENTOS DEL DOM ---
    const attachButton = document.getElementById('attachFileBtn');
    const fileInput = document.getElementById('file-input');
    const filePreviewsContainer = document.getElementById('file-previews-container');
    const inputWrapper = document.querySelector('.input-wrapper');
    const dropZone = document.body;

    // --- 2. GESTIÓN DE LA LISTA DE ARCHIVOS ---
    let attachedFiles = []; // Array para almacenar todos los archivos

    // --- 3. Mapeo de extensiones a íconos SVG (puedes agregar más)
    const fileIcons = {
        'pdf': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="8" y1="13" x2="16" y2="13"></line><line x1="8" y1="17" x2="16" y2="17"></line><line x1="10" y1="9" x2="14" y2="9"></line></svg>`,
        'txt': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="10" y2="9"></line></svg>`,
        'jpg': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 8c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3z"></path><path d="M4 4h16v16H4V4z"></path><path d="M4 16l5-5 5 5 5-5"></path></svg>`,
        'png': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 8c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3z"></path><path d="M4 4h16v16H4V4z"></path><path d="M4 16l5-5 5 5 5-5"></path></svg>`,
        'default': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V9l-7-7z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>`
    };

    // --- 4. FUNCIONALIDAD DEL BOTÓN "ADJUNTAR ARCHIVO" ---
    attachButton.addEventListener('click', () => {
        fileInput.click();
    });

    // --- 5. FUNCIONALIDAD DE "ARRASTRAR Y SOLTAR" (DRAG & DROP) ---
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    dropZone.addEventListener('drop', (e) => {
        const droppedFiles = e.dataTransfer.files;
        if (droppedFiles.length > 0) {
            addFiles(droppedFiles);
        }
    }, false);

    // --- 6. MANEJAR ARCHIVOS (TANTO DEL BOTÓN COMO DEL DRAG & DROP) ---
    fileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files.length > 0) {
            addFiles(files);
            fileInput.value = ''; // Limpiamos el input para permitir subir los mismos archivos de nuevo
        }
    });
    
    // --- 7. FUNCIONES PRINCIPALES ---

    /**
     * Añade archivos a la lista global y actualiza la vista.
     * @param {FileList} newFiles La lista de archivos a agregar.
     */
    function addFiles(newFiles) {
        // Concatenar los nuevos archivos a la lista existente
        attachedFiles = [...attachedFiles, ...Array.from(newFiles)];
        renderPreviews();
    }

    /**
     * Elimina un archivo de la lista global por su nombre y actualiza la vista.
     * @param {string} fileName El nombre del archivo a eliminar.
     */
    function removeFile(fileName) {
        attachedFiles = attachedFiles.filter(file => file.name !== fileName);
        renderPreviews();
    }

    /**
     * Renderiza todas las vistas previas de los archivos en la lista global.
     */
    function renderPreviews() {
        filePreviewsContainer.innerHTML = '';
        
        if (attachedFiles.length > 0) {
            filePreviewsContainer.classList.add('active');
            
            attachedFiles.forEach((file) => {
                const previewElement = document.createElement('div');
                previewElement.className = 'file-preview';
                
                const ext = file.name.split('.').pop().toLowerCase();
                const icon = fileIcons[ext] || fileIcons.default;
                
                previewElement.innerHTML = `
                    <div class="file-icon">${icon}</div>
                    <span class="file-name">${file.name}</span>
                    <button class="remove-btn" type="button">×</button>
                `;
                
                filePreviewsContainer.appendChild(previewElement);
                
                const removeBtn = previewElement.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => {
                    removeFile(file.name);
                });
            });
        } else {
            filePreviewsContainer.classList.remove('active');
        }
    }
    
const inputArea = document.querySelector('.input-area');

// Esta función ajustará el ancho del contenedor
function adjustPreviewContainerWidth() {
  const parentWidth = inputArea.offsetWidth;
  filePreviewsContainer.style.maxWidth = `${parentWidth}px`;
}

// Llama a la función al cargar la página y al cambiar el tamaño de la ventana
window.addEventListener('load', adjustPreviewContainerWidth);
window.addEventListener('resize', adjustPreviewContainerWidth);

// Llama a la función cada vez que se añadan archivos
fileInput.addEventListener('change', () => {
  // Lógica para manejar la selección de archivos...
  
  // Después de manejar los archivos, ajusta el ancho
  adjustPreviewContainerWidth();
  });
</script>
</body>
</html>