<!-- app/templates/chat_session.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi Chat IA</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pygments/2.10.0/styles/default.min.css"></link>
<style>
.internal-thoughts summary {
  cursor: pointer;
  user-select: none;
}

/* 🔹 Ajuste general para separación limpia */
.markdown-content p,
.markdown-content li,
.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4,
.markdown-content h5,
.markdown-content h6 {
  margin-bottom: 1em;
}

/* 🔹 Lista */
.markdown-content ul,
.markdown-content ol {
  padding-left: 1.2em;
  margin-bottom: 1em;
}

.markdown-content li {
  margin-bottom: 0.5em;
}

.markdown-content br {
  line-height: 0.5; /* controla la altura de línea del salto */
  margin-bottom: 0.2em; /* o algún valor pequeño para que se note menos */
  content: ""; /* para asegurar que se muestre el salto */
  display: block; /* que actúe como salto de línea vertical */
}

/* 🔹 Títulos */
.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4 {
  font-weight: bold;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
}

/* 🔹 Citas */
.markdown-content blockquote {
  border-left: 4px solid #ccc;
  margin: 1em 0;
  padding: 0.5em 1em;
  color: #555;
  background-color: #f9f9f9;
}

/* 🔹 Tablas */
.markdown-content table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 1em;
}

.markdown-content table,
.markdown-content th,
.markdown-content td {
  border: 1px solid #ccc;
  padding: 8px;
}

.markdown-content th {
  background-color: #f0f0f0;
  font-weight: bold;
}

/* 🔹 Código en línea */
.markdown-content code {
  background-color: #f4f4f4;
  padding: 0.2em 0.4em;
  border-radius: 4px;
  font-family: 'Courier New', Courier, monospace;
  white-space: pre-wrap;
}

/* 🔹 Código en bloques */
.markdown-content pre {
  background-color: #1e1e1e;
  color: #f8f8f2;
  white-space: pre;
  overflow-x: auto;
  padding: 1em;
  border-radius: 8px;
  margin-bottom: 1em;
  font-family: 'Courier New', Courier, monospace;
}

.markdown-content pre code {
  background: none;
  padding: 0;
  border-radius: 0;
}

.markdown-content pre code.language-ascii {
  font-family: 'Courier New', Courier, monospace;
  white-space: pre;
  background-color: #2c2c2c;
  color: #eee;
  padding: 1em;
  display: block;
}

/* 🔹 Enlaces */
.markdown-content a {
  color: #007bff;
  text-decoration: underline;
}

/* 🔹 Botones personalizados */

/* 🔹 Ajustes generales */
.markdown-content {
  font-size: 0.95rem;
  line-height: 1.6;
  color: #202020;
  word-wrap: break-word;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Segoe UI", sans-serif;
  background-color: #242424;
  color: white;
  height: 100vh;
  display: flex;
  overflow: hidden;
}

/* ===== SIDEBAR ===== */
.sidebar {
  width: 270px;
  background-color: #161616;
  display: flex;
  flex-direction: column;
  padding: 1rem;
  transition: width 0.3s ease;
  overflow: hidden;
}

.sidebar.collapsed {
  width: 60px;
}

.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem;
  border-bottom: 1px solid #333;
}

.sidebar .logo {
  height: 32px;
  width: auto;
}

.toggle-menu-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: white;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: background 0.2s;
}

.toggle-menu-btn:hover {
  background-color: #444;
}

.section-title {
  margin: 1.2rem 0 0.5rem;
  font-size: 0.9rem;
  color: #aaaaaa;
}

.sidebar .top {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar button,
.sidebar input {
  width: 100%;
  margin-bottom: 10px;
  background-color: #2a2a2a;
  border: none;
  color: white;
  padding: 10px;
  border-radius: 8px;
}

/* Footer */
.sidebar footer {
  margin-top: auto;
  padding: 0.5rem 1rem;
  display: flex;
  justify-content: center;
  border-top: 1px solid #333;
}

/* Sidebar colapsada: centrado contenido y padding */
.sidebar.collapsed {
  width: 60px;
  align-items: center;
  padding: 1rem 0.5rem;
  overflow: visible; /* para que tooltips y menús no se corten */
}

/* Header en sidebar colapsada */
.sidebar.collapsed .sidebar-header {
  flex-direction: column;
  align-items: center;
  gap: 10px;
  padding: 1rem 0;
}

/* Logo margin */
.sidebar.collapsed .logo {
  margin-bottom: 0.5rem;
  height: 32px;
  width: 32px;
}

/* Quick icons y footer alineados */
.sidebar.collapsed .quick-icons,
.sidebar.collapsed footer {
  position: relative; /* para posicionar menú */
  width: 100%;
  display: flex;
  justify-content: center;
  padding: 10px 0;
}

/* Botones icon-btn visibles y con tamaño automático */
.sidebar.collapsed .icon-btn {
  width: auto;
  padding: 10px;
  font-size: 20px;
  text-align: center;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
}

.sidebar.collapsed .icon-btn span {
  display: none;
}

/* Perfil centrado en footer */
.sidebar.collapsed .profile {
  justify-content: center;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  text-align: center;
  cursor: pointer;
  padding: 10px 0;
}

/* Imagen de perfil */
.sidebar.collapsed .profile img {
  display: flex !important; /* asegurar que esté visible */
  cursor: pointer;
  width: 48px;
  height: 48px;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  gap: 4px;
}

/* Ocultar texto y menús innecesarios en colapsado */
.sidebar.collapsed .profile-name,
.sidebar.collapsed .profile-menu,
.sidebar.collapsed .section-title,
.sidebar.collapsed .chat-list-container,
.sidebar.collapsed .top > *:not(button):not(input),
.sidebar.collapsed input[type="text"] {
  display: none !important;
}

.sidebar.collapsed .profile-menu {
  display: none;
  position: absolute;
  bottom: 60px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  border-radius: 8px;
  padding: 8px;
  min-width: 140px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.7);
  flex-direction: column;
  z-index: 9999;
}

.sidebar.collapsed .profile-menu.show {
  display: flex !important;
}

.sidebar.collapsed .profile-menu button {
  background: none;
  border: none;
  color: white;
  padding: 8px 12px;
  cursor: pointer;
  text-align: left;
  border-radius: 4px;
  transition: background 0.2s;
}

/* Mantener visibles los botones + Nuevo chat y búsqueda en .top */
.sidebar.collapsed .top > button,
.sidebar.collapsed .top > input {
  display: block !important;
  width: 40px;
  height: 40px;
  padding: 0;
  margin: 5px 0;
  border-radius: 8px;
  font-size: 22px;
  text-align: center;
  cursor: pointer;
  background-color: #2a2a2a;
  color: white;
  border: none;
}

/* Input de búsqueda colapsado - solo icono (puedes poner un icono de lupa de fondo si quieres) */
.sidebar.collapsed .top > input {
  font-size: 0; /* ocultar texto placeholder */
  position: relative;
  background: url('data:image/svg+xml;utf8,<svg fill="white" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/></svg>') no-repeat center center;
  background-size: 16px 16px;
  cursor: pointer;
  padding: 10px;
}

/* Al enfocar input mostrar texto y expandir */
.sidebar.collapsed .top > input:focus {
  font-size: 14px;
  width: 100%;
  background: transparent;
  cursor: text;
}

/* Ajustes para los chat items y botones visibles en colapsado */
.sidebar.collapsed .chat-item {
  display: flex;
  justify-content: center;
  padding: 10px 0;
}

.sidebar.collapsed .chat-item .chat-title {
  display: none;
}

.sidebar.collapsed .chat-actions,
.sidebar.collapsed .chat-dots {
  display: none !important;
}

/* Scrollbar pequeño para chat-list si decides mostrar */
.chat-list-container::-webkit-scrollbar {
  width: 6px;
}

.chat-list-container::-webkit-scrollbar-thumb {
  background-color: #555;
  border-radius: 4px;
}

/* Mantener toggle button visible y usable */
.toggle-menu-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: white;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: background 0.2s;
}

.toggle-menu-btn:hover {
  background-color: #444;
}

/* Mantener el toggle visible y centrado también en colapsado */
.sidebar.collapsed .toggle-menu-btn {
  margin: 0 auto;
}

/* Tooltips para botones en sidebar colapsada */
.icon-btn[title],
.toggle-menu-btn[title],
.top > button[title],
.profile[title] {
  position: relative;
}

.icon-btn[title]:hover::after,
.toggle-menu-btn[title]:hover::after,
.top > button[title]:hover::after,
.profile[title]:hover::after {
  content: attr(title);
  position: absolute;
  left: 110%;
  top: 50%;
  transform: translateY(-50%);
  background: #222;
  padding: 5px 10px;
  border-radius: 6px;
  white-space: nowrap;
  z-index: 1000;
  font-size: 12px;
  color: white;
  pointer-events: none;
  opacity: 0.9;
  box-shadow: 0 0 5px rgba(0,0,0,0.5);
}


/* ===== PERFIL ===== */
.profile {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  padding: 10px;
  border-radius: 8px;
  transition: background 0.2s;
}

.profile:hover {
  background-color: #2c2c2c;
}

.profile img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background-color: #555;
}

.profile-name {
  font-size: 0.9rem;
}

.profile-menu {
  position: absolute;
  bottom: 60px;
  left: 10px;
  background-color: #2a2a2a;
  border: 1px solid #444;
  border-radius: 10px;
  padding: 10px;
  width: 200px;
  display: none;
  flex-direction: column;
  z-index: 100;
  align-items: center;
  gap: 0.5rem;
}

.profile-menu a {
  display: block;
  width: 100%;
  text-align: center;
  padding: 8px 12px;
  background: none;
  border: none;
  color: #f0f0f0;
  text-decoration: none;
  border-radius: 6px;
  font-size: 0.95rem;
  transition: background-color 0.2s, color 0.2s;
}

.profile-menu a:hover {
  background-color: #3a3a3a;
  color: #ffffff;
}

/* Opcional: eliminar el estilo azul al hacer focus */
.profile-menu button:focus {
  outline: none;
  box-shadow: none;
}


/* ===== CHAT LISTA ===== */
.chat-list-container {
  flex: 1;
  overflow-y: auto;
  padding-right: 5px;
  margin-bottom: 1rem;
}

.chat-list-container::-webkit-scrollbar {
  width: 6px;
}

.chat-list-container::-webkit-scrollbar-thumb {
  background-color: #555;
  border-radius: 4px;
}

.chat-list-container ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.chat-list-container li {
  padding: 8px 12px;
  border-radius: 8px;
  transition: background-color 0.2s;
  color: #e0e0e0;
  cursor: pointer;
  margin-bottom: 8px;
}

.chat-list-container li:hover {
  background-color: #2c2c2c;
}

.chat-list-container li.selected {
  background-color: #3a3a3a;
}

/* ===== ITEM CHAT ===== */
.chat-item {
  position: relative;
  display: flex;
  align-items: center;
  padding: 12px 16px;
  margin-bottom: 8px;
  border-radius: 8px;
  background-color: inherit;
  transition: background-color 0.2s;
}

.chat-item:hover,
.chat-item.selected {
  background-color: #2e2e2e;
}

.chat-title {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-right: 40px;
}

/* Botones */
.chat-dots {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  cursor: pointer;
  color: #aaa;
  transition: color 0.2s;
}

.chat-dots:hover {
  color: #fff;
}

.chat-actions {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  display: none;
  gap: 5px;
}

.chat-actions button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
  padding: 4px;
  border-radius: 4px;
  transition: background 0.2s;
  color: white;
}

.chat-actions button:hover {
  background-color: #444;
}

.chat-item:hover .chat-actions,
.chat-item.selected .chat-actions {
  display: flex;
}

.chat-item:hover .chat-dots,
.chat-item.selected .chat-dots {
  display: none;
}

/* ===== MAIN ===== */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: end;
  align-items: center;
  padding: 2rem;
}

/* ===== INPUT AREA ===== */
.input-area {
  width: 60%;
  position: relative;
  margin-top: 50px;
}

.input-wrapper {
  background-color: #2c2c2c;
  border-radius: 10px;
  display: flex;
  align-items: center;
  padding: 10px;
  padding: 10px 60px 10px 60px;
  gap: 10px;
}

.input-wrapper textarea {
  display: block !important;    /* forzamos que se vea */
  flex: 1 !important;           /* ocupe todo el espacio disponible */  /* texto legible */
  line-height: 1.5em !important;
  color: white !important;      /* texto en blanco */
  background: transparent !important; /* fondo transparente (ya lo define .input-wrapper) */
  border: none !important;      /* sin borde extra */
  padding: 10px 0 !important;   /* un poco de espacio interno */
  overflow-y: auto;             /* scroll interno tras 7 líneas */
  min-height: 1.6em;         /* altura de 1 línea */
  max-height: calc(1.6em * 7 + 0,3); /* hasta 7 líneas */
  font-size: 18px !important;
  resize: none;    
}

.input-wrapper textarea::placeholder {
  color: #888 !important;
  opacity: 1; /* algunos navegadores bajan la opacidad por defecto */
}

.input-wrapper textarea:focus {
  outline: none;
}

.input-wrapper .attach-btn {
  width: auto !important;        /* que no ocupe todo */
  height: auto !important;
  padding: 6px !important;       /* tamaño cómodo para clic */
  position: absolute !important; /* lo sacamos del flow flex */
  left: 15px !important;         /* alineado a la izquierda */
  bottom: 15px !important;       /* alineado al bottom */
  background: none !important;   
  color: white !important;
  font-size: 20px !important;
  z-index: 2 !important;         /* encima del textarea */
}

/* Y como ya lo posicionamos, quitamos su margen interior en flex */
.input-wrapper {
  padding-left: 60px;            /* deja espacio al “+” */
}

.input-buttons {
  display: flex;
  align-items: center;
  gap: 10px;
}

.input-buttons button {
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

.send-btn {
  position: absolute;
  right: 15px;
  bottom: 15px;
  background-color: #444;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

/* ===== ICONOS RÁPIDOS ===== */
.quick-icons {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 1rem;
}

.response-actions {
  display: flex;
  gap: 8px;
  margin-top: 6px;
}

.icon-btn {
  background: none;
  border: none;
  padding: 4px;
  border-radius: 6px;
  cursor: pointer;
  color: #ccc;
  transition: background-color 0.2s;
  font-size: 18px;
}

.icon-btn:hover {
  background-color: #2a2a2a;
  color: white;
}


/* Contenedor principal de mensajes */
.chat-window {
  width: 60%;            
  margin: 0 auto;       
  display: flex;
  flex-direction: column;
  z-index: 3;
  justify-content: start !important;
  height: 90%;
  position: relative;
}

.messages {
  background-color: #121212;
  padding: 16px;
  overflow-y: auto;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.message.user,
.assistant-group.message.assistant {
  display: flex;
  width: 100%;
}

/* Burbujas de usuario */
.message.user {
  background: transparent !important;
  display: flex;
  justify-content: flex-end;
}

.message.user .message-bubble {
  background-color: #444444;
  color: #fff;
  border-radius: 18px 18px 0 18px;
  padding: 5px 14px;
  max-width: 75%;
  word-wrap: break-word;
}

/* Burbujas de asistente */
.assistant-group.message.assistant {
  background: transparent !important;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.assistant-group.message.assistant .version {
  background-color: transparent;
  color: #e5e5e5;
  border-radius: 18px 18px 18px 0;
  padding: 10px 14px;
  max-width: 100% !important;
  word-wrap: break-word;
  margin-bottom: 8px;
}

.message.user .message-bubble {
  max-width: 75%;          /* no se alargue demasiado */
}

/* Razonamiento desplegable */
.assistant-group.message.assistant details {
  background-color: #2a2a2a;
  border-radius: 6px;
  padding: 8px;
  color: #ccc;
}

/* Ajustes del scrollbar interno */
.messages::-webkit-scrollbar {
  width: 8px;
}

.messages::-webkit-scrollbar-track {
  background: #1e1e1e;
  border-radius: 4px;
}

.messages::-webkit-scrollbar-thumb {
  background: #444;
  border-radius: 4px;
}

.messages::-webkit-scrollbar-thumb:hover {
  background: #666;
}

.file-upload-icon {
  position: absolute;
  left: 15px;
  bottom: 15px;
  background-color: #444;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  color: white;
  cursor: pointer;
  padding: 6px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.file-upload-icon:hover {
  background-color: #3a3a3a;
}

/* Ocultamos el input real */
.file-input-hidden {
  display: none;
}

.file-preview-area {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 10px;
  background-color: #1e1e1e;
  max-width: 100%;
}

/* Cada archivo */
.file-preview {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100px;
  max-width: 100px;
  font-size: 0.75rem;
  color: #ccc;
}

/* Estilo para imágenes */
.file-preview img,
.file-preview video {
  width: 100px;
  height: 80px;
  object-fit: cover;
  border-radius: 6px;
  margin-bottom: 5px;
  background-color: #333;
}

/* Íconos de archivos genéricos */
.file-preview .file-icon {
  width: 80px;
  height: 80px;
  background-color: #333;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: #999;
  margin-bottom: 5px;
}

.attach-menu {
  position: absolute;
  bottom: 60px;              /* ajusta según la altura del input */
  left: 50px;                /* ajusta la posición horizontal */
  background-color: #2a2a2a;
  border: 1px solid #444;
  border-radius: 8px;
  display: none;
  flex-direction: column;
  padding: 8px 0;
  z-index: 1000;
}

.attach-menu-item {
  background: none;
  border: none;
  color: #f0f0f0;
  padding: 8px 12px;
  width: 100%;
  text-align: left;
  cursor: pointer;
  font-size: 0.95rem;
  transition: background 0.2s;
}

.attach-menu-item:hover {
  background-color: #3a3a3a;
}

  textarea {
    resize: none;
    font-size: 16px;
    line-height: 1.5em;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #444;
    background: #333;
    color: white;
    max-height: calc(1.5em * 7 + 16px);
    overflow-y: auto;
  }

.chat-menu-container {
  position: relative;
  display: inline-block;
}

.menu-toggle-btn {
  background: none;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ccc;
  width: 28px;
  height: 28px;
  outline: none;          /* quita borde de foco (click) */
  box-shadow: none;       /* por si algún estilo le da sombra */
}

.menu-toggle-btn:hover,
.menu-toggle-btn:focus,
.menu-toggle-btn:active {
  background: none;
  outline: none;
  box-shadow: none;
}


.chat-dropdown-menu {
  position: absolute;
  top: 30px;
  right: 0;
  background-color: #2a2a2a;
  border: 1px solid #444;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  padding: 0.2rem;
  z-index: 100;
}

.chat-dropdown-menu button {
  display: block;
  width: 100%;
  background: none;
  border: none;
  color: #eee;
  text-align: center;
  cursor: pointer;
  font-size: 0.9rem;
  text-decoration: none;
  border-radius: 6px;
  font-size: 0.95rem;
}

.chat-dropdown-menu button:hover {
  background-color: #3a3a3a;
  color: #ffffff;
}

.hidden {
  display: none;
}

.sidebar:not(.collapsed) .sidebar-header {
  position: relative;
}

/* Posicionar el botón en la esquina superior derecha */
.sidebar:not(.collapsed) .toggle-menu-btn {
  position: absolute;
  top: 1rem;    /* ajusta a tu gusto */
  right: 1rem;  /* ajusta a tu gusto */
  width: auto;  /* que no se extienda a todo el ancho */
  padding: 4px; /* el padding que ya tenías */
}

.sidebar:not(.collapsed) .icon-btn span {
  font-size: 1rem;    /* o el valor que prefieras, ej. 1.2rem */
  margin-left: 0.5em; /* separa un poco del SVG */
  line-height: 1;     /* para que quede centrado con el icono */
  text-align: center;
}

.sidebar:not(.collapsed) .icon-btn {
  display: flex;                /* activa flexbox */
  align-items: center;          /* centra verticalmente */
  justify-content: center;      /* centra horizontalmente */
  gap: 0.5em;                   /* espacio entre icono y texto */
  padding: 0.5em 1em;           /* ajusta el padding a tu gusto */
}

/* Cuando el sidebar está colapsado: */
.sidebar.collapsed .new-session-btn,
.sidebar.collapsed .search-btn {
  width: auto;          /* Que no se estiren */
  padding: 8px;         /* Mantén solo algo de “click area” */
  text-indent: -9999px; /* Empuja cualquier texto (por si) fuera de la vista */
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ==== RESPONSIVE: móvil (≤770px) ==== */
@media (max-width: 770px) {
  .main {
   justify-content: end !important;
  }

  .main h1 {
    height: 90%;
    position: relative;
  }

  .sidebar {
    display: none !important;
    position: fixed;
    top: 0; left: 0;
    height: 100vh;
    width: 250px;
    background-color: #161616;
    flex-direction: column;
    z-index: 1000;
    padding-top: 3.5rem;
  }
  .sidebar.show {
    display: flex !important;
  }

  /* Renombrado: mobile-toggle-btn */
  .mobile-toggle-btn {
    display: block !important;
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 1100;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: white;
    cursor: pointer;
  }

  .mobile-toggle-btn.hidden {
    display: none !important;
  }

  .input-area {
  width: 95%;
  position: relative;
  }

  .chat-window {
  width: 100% !important;            
  margin: 0 auto;       
  display: flex;
  flex-direction: column;
  z-index: 3;
  justify-content: start !important;
 }
}
</style>
</head>
<body>
  <button class="mobile-toggle-btn" title="Mostrar / Ocultar menú" style="display: none;">
    ☰
  </button>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="{{ url_for('static', filename='img/logo_sidelbar.png') }}" alt="Logo" class="logo-fixed;">
      <button class="toggle-menu-btn" title="Mostrar / Ocultar menú">☰</button>
    </div>

<svg style="display: none;">
  <symbol id="icon-plus" viewBox="0 0 24 24">
    <path d="M12 5v14M5 12h14"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </symbol>
  <symbol id="icon-search" viewBox="0 0 24 24">
    <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"/>
    <line x1="16.5" y1="16.5" x2="21" y2="21"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </symbol>
</svg>

    <!-- Iconos rápidos visibles en modo colapsado -->
    <div class="quick-icons">
<button class="icon-btn new-session-btn" title="Nuevo chat">
  <svg width="20" height="20" aria-hidden="true">
    <use xlink:href="#icon-plus"/>
  </svg>
  <span class="sr-only">Nuevo chat</span>
</button>

<!-- Botón Buscar -->
<button id="searchBtn" class="icon-btn search-btn" title="Buscar">
  <svg width="20" height="20" aria-hidden="true">
    <use xlink:href="#icon-search"/>
  </svg>
  <span class="sr-only">Buscar</span>
</button>
    </div>

    <!-- Buscador -->
    <div id="searchContainer" style="display:none; margin: 8px;">
      <input type="text" id="searchInput" placeholder="Buscar chats..." style="width: 100%; padding: 4px;" />
      <ul id="searchResults" style="list-style:none; padding-left:0; max-height:150px; overflow-y:auto; margin-top:4px;"></ul>
    </div>

    <!-- Lista de Chats -->
    <div class="top">
      <div class="section-title">Chats</div>
      <div class="chat-list-container">
        <ul>
          {% for session in sessions %}
          <li class="chat-item {% if session.id == selected_session_id %}selected{% endif %}" data-session-id="{{ session.id }}">
            <span class="chat-title">{{ session.name or "Chat sin nombre" }}</span>
<div class="chat-menu-container">
  <button class="menu-toggle-btn" aria-label="Abrir menú">
    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon" aria-hidden="true"><path d="M15.498 8.50159C16.3254 8.50159 16.9959 9.17228 16.9961 9.99963C16.9961 10.8271 16.3256 11.4987 15.498 11.4987C14.6705 11.4987 14 10.8271 14 9.99963C14.0002 9.17228 14.6706 8.50159 15.498 8.50159Z"></path><path d="M4.49805 8.50159C5.32544 8.50159 5.99689 9.17228 5.99707 9.99963C5.99707 10.8271 5.32555 11.4987 4.49805 11.4987C3.67069 11.4985 3 10.827 3 9.99963C3.00018 9.17239 3.6708 8.50176 4.49805 8.50159Z"></path><path d="M10.0003 8.50159C10.8276 8.50176 11.4982 9.17239 11.4984 9.99963C11.4984 10.827 10.8277 11.4985 10.0003 11.4987C9.17283 11.4987 8.50131 10.8271 8.50131 9.99963C8.50149 9.17228 9.17294 8.50159 10.0003 8.50159Z"></path></svg>
  </button>
  <div class="chat-dropdown-menu hidden">
    <button class="rename-btn" data-session-id="{{ session.id }}">Renombrar</button>
    <button class="delete-btn" data-session-id="{{ session.id }}">Eliminar</button>
  </div>
</div>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Perfil en el footer -->
    <footer>
      <div class="profile" onclick="toggleProfileMenu()">
        <img src="https://ui-avatars.com/api/?name={{ full_name|replace(' ', '+') }}&background=555&color=fff" alt="avatar" />
        <div class="profile-name">{{ full_name }}</div>
      </div>

      <div class="profile-menu" id="profileMenu">
        <a href="#" id="memoriaBtn"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon" aria-hidden="true"><path d="M7.91626 11.0013C9.43597 11.0013 10.7053 12.0729 11.011 13.5013H16.6663L16.801 13.515C17.1038 13.5771 17.3311 13.8453 17.3313 14.1663C17.3313 14.4875 17.1038 14.7555 16.801 14.8177L16.6663 14.8314H11.011C10.7056 16.2601 9.43619 17.3314 7.91626 17.3314C6.39643 17.3312 5.1269 16.2601 4.82153 14.8314H3.33325C2.96598 14.8314 2.66821 14.5336 2.66821 14.1663C2.66839 13.7992 2.96609 13.5013 3.33325 13.5013H4.82153C5.12713 12.0729 6.39665 11.0015 7.91626 11.0013ZM7.91626 12.3314C6.90308 12.3316 6.08148 13.1532 6.0813 14.1663C6.0813 15.1797 6.90297 16.0011 7.91626 16.0013C8.9297 16.0013 9.75122 15.1798 9.75122 14.1663C9.75104 13.153 8.92959 12.3314 7.91626 12.3314ZM12.0833 2.66829C13.6031 2.66829 14.8725 3.73966 15.178 5.16829H16.6663L16.801 5.18196C17.1038 5.24414 17.3313 5.51212 17.3313 5.83333C17.3313 6.15454 17.1038 6.42253 16.801 6.4847L16.6663 6.49837H15.178C14.8725 7.92701 13.6031 8.99837 12.0833 8.99837C10.5634 8.99837 9.29405 7.92701 8.98853 6.49837H3.33325C2.96598 6.49837 2.66821 6.2006 2.66821 5.83333C2.66821 5.46606 2.96598 5.16829 3.33325 5.16829H8.98853C9.29405 3.73966 10.5634 2.66829 12.0833 2.66829ZM12.0833 3.99837C11.0698 3.99837 10.2483 4.81989 10.2483 5.83333C10.2483 6.84677 11.0698 7.66829 12.0833 7.66829C13.0967 7.66829 13.9182 6.84677 13.9182 5.83333C13.9182 4.81989 13.0967 3.99837 12.0833 3.99837Z"></path></svg> Memoria</a>
        <a href="#" id="logoutBtn"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" data-rtl-flip="" class="icon" aria-hidden="true"><path d="M3.50171 12.6663V7.33333C3.50171 6.64424 3.50106 6.08728 3.53784 5.63704C3.57525 5.17925 3.65463 4.77342 3.84644 4.39681L3.96851 4.17806C4.2726 3.68235 4.70919 3.2785 5.23023 3.01302L5.3728 2.94661C5.7091 2.80238 6.06981 2.73717 6.47046 2.70443C6.9207 2.66764 7.47766 2.66829 8.16675 2.66829H9.16675L9.30054 2.68197C9.60367 2.7439 9.83179 3.0119 9.83179 3.33333C9.83179 3.65476 9.60367 3.92277 9.30054 3.9847L9.16675 3.99837H8.16675C7.45571 3.99837 6.96238 3.99926 6.57886 4.0306C6.297 4.05363 6.10737 4.09049 5.96362 4.14193L5.83374 4.19857C5.53148 4.35259 5.27861 4.58671 5.1023 4.87435L5.03198 5.00032C4.95147 5.15833 4.89472 5.36974 4.86401 5.74544C4.83268 6.12896 4.83179 6.6223 4.83179 7.33333V12.6663C4.83179 13.3772 4.8327 13.8707 4.86401 14.2542C4.8947 14.6298 4.95153 14.8414 5.03198 14.9993L5.1023 15.1263C5.27861 15.4137 5.53163 15.6482 5.83374 15.8021L5.96362 15.8577C6.1074 15.9092 6.29691 15.947 6.57886 15.9701C6.96238 16.0014 7.45571 16.0013 8.16675 16.0013H9.16675L9.30054 16.015C9.6036 16.0769 9.83163 16.345 9.83179 16.6663C9.83179 16.9877 9.60363 17.2558 9.30054 17.3177L9.16675 17.3314H8.16675C7.47766 17.3314 6.9207 17.332 6.47046 17.2952C6.06978 17.2625 5.70912 17.1973 5.3728 17.0531L5.23023 16.9867C4.70911 16.7211 4.27261 16.3174 3.96851 15.8216L3.84644 15.6038C3.65447 15.2271 3.57526 14.8206 3.53784 14.3626C3.50107 13.9124 3.50171 13.3553 3.50171 12.6663ZM13.8035 13.804C13.5438 14.0634 13.1226 14.0635 12.863 13.804C12.6033 13.5443 12.6033 13.1223 12.863 12.8626L13.8035 13.804ZM12.863 6.19661C13.0903 5.96939 13.4409 5.94126 13.699 6.11165L13.8035 6.19661L17.1375 9.52962C17.3969 9.78923 17.3968 10.2104 17.1375 10.4701L13.8035 13.804L13.3337 13.3333L12.863 12.8626L15.0603 10.6654H9.16675C8.79959 10.6654 8.50189 10.3674 8.50171 10.0003C8.50171 9.63306 8.79948 9.33529 9.16675 9.33529H15.0613L12.863 7.13704L12.7781 7.03255C12.6077 6.77449 12.6359 6.42386 12.863 6.19661Z"></path></svg> Cerrar sesión</a>
      </div>
    </footer>
  </aside>

  <!-- Área principal -->
  <main class="main">
    <div class="chat-window">
      {% set ns = namespace(last_user_text='') %}
      {% for msg in messages %}
        {% if msg.sender == 'user' %}
          {% set ns.last_user_text = msg.text | markdown | safe %}
          <div class="message user">
            <div class="message-bubble">
                <p class="message-text markdown-content">{{ msg.text | markdown | safe }}</p>
            </div>
          </div>
        {% else %}
          <div class="assistant-group message assistant" data-group-id="{{ msg.id }}" data-current-index="1">
            {% if msg.thought_process %}
              <details class="mt-2 mb-2">
                <summary><strong>Razonamiento</strong></summary>
                <pre style="white-space: pre-wrap;">{{ msg.thought_process }}</pre>
              </details>
            {% endif %}

            <div class="version" data-index="1">{{ msg.text | markdown | safe }}</div>

<div class="response-actions">
  <!-- Copiar -->
  <button class="icon-btn copy-btn" title="Copiar" data-text="{{ msg.text|e }}">
    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>
  </button>
</div>

          </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Input del usuario -->
    <div class="input-area">
      <div class="input-wrapper">
  <!-- Botón “+” para desplegar menú -->
  <button type="button" class="icon-btn attach-btn" title="Opciones">
    <!-- SVG de “+” -->
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>

  <!-- Mini-menú desplegable -->
  <div class="attach-menu" id="attachMenu">
    <button type="button" id="attachFileBtn" class="attach-menu-item">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M4.33496 12.5V7.5C4.33496 7.13273 4.63273 6.83496 5 6.83496C5.36727 6.83496 5.66504 7.13273 5.66504 7.5V12.5C5.66504 14.8942 7.60585 16.835 10 16.835C12.3942 16.835 14.335 14.8942 14.335 12.5V5.83301C14.3348 4.35959 13.1404 3.16522 11.667 3.16504C10.1934 3.16504 8.99822 4.35948 8.99805 5.83301V12.5C8.99805 13.0532 9.44679 13.502 10 13.502C10.5532 13.502 11.002 13.0532 11.002 12.5V7.5C11.002 7.13273 11.2997 6.83496 11.667 6.83496C12.0341 6.83514 12.332 7.13284 12.332 7.5V12.5C12.332 13.7877 11.2877 14.832 10 14.832C8.71226 14.832 7.66797 13.7877 7.66797 12.5V5.83301C7.66814 3.62494 9.45888 1.83496 11.667 1.83496C13.875 1.83514 15.6649 3.62505 15.665 5.83301V12.5C15.665 15.6287 13.1287 18.165 10 18.165C6.87131 18.165 4.33496 15.6287 4.33496 12.5Z"></path></svg> Adjuntar archivo
    </button>
    <button type="button" id="callMenuBtn" class="attach-menu-item">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M7.167 15.416V4.583a.75.75 0 0 1 1.5 0v10.833a.75.75 0 0 1-1.5 0Zm4.166-2.5V7.083a.75.75 0 0 1 1.5 0v5.833a.75.75 0 0 1-1.5 0ZM3 11.25V8.75a.75.75 0 0 1 1.5 0v2.5a.75.75 0 0 1-1.5 0Zm12.5 0V8.75a.75.75 0 0 1 1.5 0v2.5a.75.75 0 0 1-1.5 0Z"></path></svg> Llamada
    </button>
  </div>

  <!-- Preview de archivos seleccionados -->
  <div id="selected-files-preview" class="file-preview-area"></div>

  <!-- Input real oculto -->
  <input id="file-input" class="file-input-hidden" type="file" name="file" multiple/>

  <!-- Textarea -->
  <textarea id="prompt" placeholder="Escribe tu mensaje aquí..."></textarea>

  <!-- Botón enviar -->
  
  <button class="send-btn" title="Enviar">↑</button>
</div>

    </div>
  </main>
</body>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// ========================================
// CHAT SESSION - CONEXIÓN CON BACKEND
// ========================================

let currentEventSource = null;
let selectedFiles = [];
const sessionId = parseInt(window.location.pathname.split('/').pop());

// DOM Elements
const promptTextarea = document.getElementById('prompt');
const sendBtn = document.querySelector('.send-btn');
const attachBtn = document.querySelector('.attach-btn');
const attachMenu = document.getElementById('attachMenu');
const fileInput = document.getElementById('file-input');
const attachFileBtn = document.getElementById('attachFileBtn');
const selectedFilesPreview = document.getElementById('selected-files-preview');
const chatWindow = document.querySelector('.chat-window');
// ========================================
// INICIALIZACIÓN
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    initializeChat();
    setupEventListeners();
    scrollToBottom();
});

function initializeChat() {
    // Focus en el textarea
    promptTextarea?.focus();
    
    // Auto-resize del textarea
    if (promptTextarea) {
        promptTextarea.addEventListener('input', autoResizeTextarea);
        autoResizeTextarea.call(promptTextarea);
    }
}

function setupEventListeners() {
    // Envío de mensajes
    sendBtn?.addEventListener('click', sendMessage);
    promptTextarea?.addEventListener('keydown', handleKeyDown);
    
    // Manejo de archivos
    attachBtn?.addEventListener('click', toggleAttachMenu);
    attachFileBtn?.addEventListener('click', () => fileInput?.click());
    fileInput?.addEventListener('change', handleFileSelection);
    
    // Cerrar menú al hacer click fuera
    document.addEventListener('click', closeAttachMenuOnClickOutside);
    
    // Botones de acciones de mensajes
    setupMessageActionButtons();
}

// ========================================
// ENVÍO DE MENSAJES
// ========================================


function sendMessage() {
    const prompt = promptTextarea?.value.trim();
    
    if (!prompt && selectedFiles.length === 0) {
        return;
    }
    
    // Deshabilitar botón mientras se procesa
    toggleSendButton(false);
    
    // Crear mensaje de usuario en UI
    addUserMessage(prompt, selectedFiles);
    
    // Limpiar input
    promptTextarea.value = '';
    selectedFiles = [];
    updateFilePreview();
    autoResizeTextarea.call(promptTextarea);
    
    // Crear placeholder para respuesta del asistente
    const assistantMessageElement = addAssistantPlaceholder();
    
    // Enviar al backend usando SSE
    streamChatResponse(prompt, selectedFiles, assistantMessageElement);
    
    scrollToBottom();
}

// Modifica estas funciones en tu código existente:

function streamChatResponse(prompt, files, assistantElement) {
    // Cerrar conexión anterior si existe
    if (currentEventSource) {
        currentEventSource.close();
    }
    
    // Preparar FormData
    const formData = new FormData();
    formData.append('prompt', prompt);
    
    // Agregar archivos
    files.forEach(file => {
        formData.append('file', file);
    });
    
    // Conectar a endpoint de streaming
    fetch(`/stream_chat/${sessionId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.body;
    })
    .then(body => {
        const reader = body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let streamCompleted = false; // 🆕 Flag para controlar si el stream terminó
        
        function readStream() {
            return reader.read().then(({ done, value }) => {
                if (done) {
                    streamCompleted = true; // 🆕 Marcar como completado
                    toggleSendButton(true);
                    
                    // 🆕 RECARGA AUTOMÁTICA DESPUÉS DEL STREAMING
                    setTimeout(() => {
                        console.log('💫 Recargando página después de completar respuesta...');
                        window.location.reload();
                    }, 0); // Espera 1.5 segundos para que el usuario vea la respuesta
                    
                    return;
                }
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Guardar línea incompleta
                
                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6).trim();
                        
                        if (data.startsWith('[DONE]')) {
                            // Mensaje completado
                            try {
                                const payload = JSON.parse(data.substring(6));
                                handleMessageComplete(assistantElement, payload);
                            } catch (e) {
                                console.error('Error parsing DONE payload:', e);
                            }
                            streamCompleted = true; // 🆕 Marcar como completado
                            toggleSendButton(true);
                            
                            // 🆕 RECARGA AUTOMÁTICA
                            setTimeout(() => {
                                console.log('💫 Recargando página después de [DONE]...');
                                window.location.reload();
                            }, 1500);
                            
                            return;
                        } else if (data.startsWith('[ERROR]')) {
                            // Error
                            handleStreamError(assistantElement, data.substring(7));
                            streamCompleted = true; // 🆕 También marcar en error
                            toggleSendButton(true);
                            
                            // 🆕 RECARGA TAMBIÉN EN ERROR (opcional)
                            setTimeout(() => {
                                console.log('💫 Recargando página después de error...');
                                window.location.reload();
                            }, 3000); // Más tiempo en caso de error
                            
                            return;
                        } else {
                            try {
                                const jsonData = JSON.parse(data);
                                if (jsonData.chunk) {
                                    appendToAssistantMessage(assistantElement, jsonData.chunk);
                                } else if (jsonData.error) {
                                    handleStreamError(assistantElement, jsonData.error);
                                    streamCompleted = true; // 🆕 Marcar como completado en error
                                    
                                    // 🆕 RECARGA EN ERROR
                                    setTimeout(() => {
                                        console.log('💫 Recargando página después de error...');
                                        window.location.reload();
                                    }, 3000);
                                }
                            } catch (e) {
                                console.warn('Received non-JSON data:', data);
                                appendToAssistantMessage(assistantElement, data);
                            }
                        }
                    }
                });
                
                return readStream();
            });
        }
        
        return readStream();
    })
    .catch(error => {
        console.error('Error en streaming:', error);
        handleStreamError(assistantElement, error.message);
        toggleSendButton(true);
        
        // 🆕 RECARGA TAMBIÉN EN CASO DE ERROR DE CONEXIÓN
        setTimeout(() => {
            console.log('💫 Recargando página después de error de conexión...');
            window.location.reload();
        }, 3000);
    });
}


// ========================================
// MANEJO DE UI - MENSAJES
// ========================================
function addUserMessage(text, files) {
    const userMessage = document.createElement('div');
    userMessage.className = 'message user';
    
    let fileText = '';
    files.forEach(file => {
        fileText += `<div class="file-attachment">📎 ${file.name}</div>`;
    });
    
    userMessage.innerHTML = `
        <div class="message-bubble">
            ${fileText}
            <p class="message-text markdown-content">${escapeHtml(text)}</p>
        </div>
    `;
    
    chatWindow?.appendChild(userMessage);
    scrollToBottom();
}

function addAssistantPlaceholder() {
    const assistantMessage = document.createElement('div');
    assistantMessage.className = 'assistant-group message assistant';
    assistantMessage.innerHTML = `
        <div class="version" data-index="1">
            <div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    
    chatWindow?.appendChild(assistantMessage);
    scrollToBottom();
    return assistantMessage;
}

// ✅ Esta función ya no necesita cambios, pero la dejo por claridad
function appendToAssistantMessage(element, text) {
    const versionDiv = element.querySelector('.version[data-index="1"]');
    if (versionDiv) {
        // Remover indicador de typing si existe
        const typingIndicator = versionDiv.querySelector('.typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
        
        // Si no hay contenido, crear el div inicial
        if (!versionDiv.dataset.hasContent) {
            versionDiv.innerHTML = '';
            versionDiv.dataset.hasContent = 'true';
        }
        
        // ✅ Ahora 'text' ya es solo el contenido del chunk, no JSON
        versionDiv.innerHTML += escapeHtml(text);
        scrollToBottom();
    }
}

function handleMessageComplete(element, payload) {
    // Agregar botones de acción
    const actionsHTML = `
        <div class="response-actions">
            <button class="icon-btn copy-btn" title="Copiar">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>
            </button>
        </div>
    `;
    
    element.innerHTML += actionsHTML;
    
    // Configurar eventos de botones
    setupMessageActionButtons(element);
    
    scrollToBottom();
    
    // 🆕 TAMBIÉN RECARGA AQUÍ COMO RESPALDO
    setTimeout(() => {
        console.log('💫 Recargando página desde handleMessageComplete...');
        window.location.reload();
    }, 0); // 2 segundos de retraso
}

// 🆕 FUNCIÓN OPCIONAL: Agregar control manual para deshabilitar la recarga
function toggleAutoReload(enabled) {
    window.autoReloadEnabled = enabled;
    console.log(`Auto-recarga ${enabled ? 'habilitada' : 'deshabilitada'}`);
}

// 🆕 INICIALIZAR EL ESTADO DE AUTO-RECARGA (por defecto habilitado)
window.autoReloadEnabled = true;

// ========================================
// MANEJO DE ARCHIVOS
// ========================================
function handleFileSelection(event) {
    const files = Array.from(event.target.files);
    selectedFiles = [...selectedFiles, ...files];
    updateFilePreview();
    closeAttachMenu();
}

function updateFilePreview() {
    if (selectedFiles.length === 0) {
        selectedFilesPreview.style.display = 'none';
        return;
    }
    
    selectedFilesPreview.style.display = 'block';
    selectedFilesPreview.innerHTML = selectedFiles.map((file, index) => `
        <div class="file-preview-item">
            <span class="file-name">📎 ${file.name}</span>
            <button class="remove-file-btn" data-index="${index}">×</button>
        </div>
    `).join('');
    
    // Event listeners para remover archivos
    selectedFilesPreview.querySelectorAll('.remove-file-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            selectedFiles.splice(index, 1);
            updateFilePreview();
        });
    });
}

function toggleAttachMenu() {
    attachMenu.classList.toggle('hidden');
}

function closeAttachMenu() {
    attachMenu.classList.add('hidden');
}

function closeAttachMenuOnClickOutside(event) {
    if (!attachBtn.contains(event.target) && !attachMenu.contains(event.target)) {
        closeAttachMenu();
    }
}

// ========================================
// UTILIDADES
// ========================================
function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function toggleSendButton(enabled) {
    if (sendBtn) {
        sendBtn.disabled = !enabled;
        sendBtn.style.opacity = enabled ? '1' : '0.5';
    }
}

function autoResizeTextarea() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
}

function scrollToBottom() {
    chatWindow?.scrollTo({
        top: chatWindow.scrollHeight,
        behavior: 'smooth'
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ========================================
// BOTONES DE ACCIONES DE MENSAJES
// ========================================
function setupMessageActionButtons(container = document) {
    // Botón copiar
    container.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const textContent = this.closest('.assistant-group').querySelector('.version').textContent;
            navigator.clipboard.writeText(textContent).then(() => {
                // Feedback visual
                this.style.color = '#4CAF50';
                setTimeout(() => this.style.color = '', 2000);
            });
        });
    });
    
    // Botón regenerar
    container.querySelectorAll('.regen-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Obtener el último mensaje de usuario
            const userMessages = chatWindow.querySelectorAll('.message.user');
            if (userMessages.length > 0) {
                const lastUserMessage = userMessages[userMessages.length - 1];
                const messageText = lastUserMessage.querySelector('.message-text').textContent;
                
                // Remover la respuesta actual del asistente
                this.closest('.assistant-group').remove();
                
                // Enviar mensaje nuevamente
                const assistantPlaceholder = addAssistantPlaceholder();
                streamChatResponse(messageText, [], assistantPlaceholder);
            }
        });
    });
}

// ========================================
// REPRODUCCIÓN DE AUDIO (TTS)
// ========================================
function playAudio(audioUrl) {
    const audio = new Audio(audioUrl);
    audio.play().catch(error => {
        console.error('Error reproduciendo audio:', error);
    });
}

  // =======================
  // 👤 Search bar
  // =======================
const searchBtn = document.getElementById('searchBtn');
const searchContainer = document.getElementById('searchContainer');
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const chatListContainer = document.querySelector('.chat-list-container ul');

if (searchBtn && searchContainer && searchInput && searchResults && chatListContainer) {

  // Mostrar/ocultar contenedor búsqueda
  searchBtn.addEventListener('click', () => {
    if (searchContainer.style.display === 'none' || !searchContainer.style.display) {
      searchContainer.style.display = 'block';
      searchInput.focus();
    } else {
      searchContainer.style.display = 'none';
      searchInput.value = '';
      searchResults.innerHTML = '';
      chatListContainer.style.display = 'block';
    }
  });

  // Filtrar mientras escribís
  searchInput.addEventListener('input', () => {
    const q = searchInput.value.toLowerCase().trim();
    if (q === '') {
      searchResults.innerHTML = '';
      chatListContainer.style.display = 'block';
      return;
    }

    // Ocultar lista original
    chatListContainer.style.display = 'none';

    // Filtrar chats
    const matches = [];
    document.querySelectorAll('.chat-item').forEach(item => {
      const title = item.querySelector('.chat-title').textContent.toLowerCase();
      if (title.includes(q)) {
        matches.push({
          id: item.getAttribute('data-session-id'),
          name: item.querySelector('.chat-title').textContent
        });
      }
    });

    if (matches.length === 0) {
      searchResults.innerHTML = '<li>No se encontraron chats.</li>';
    } else {
      searchResults.innerHTML = matches.map(m => 
        `<li class="search-result-item" data-session-id="${m.id}" style="padding:4px; cursor:pointer; border-bottom:1px solid #ccc;">
          ${m.name}
        </li>`).join('');
    }
  });

  // Click en resultado para ir al chat
  searchResults.addEventListener('click', e => {
    const li = e.target.closest('.search-result-item');
    if (!li) return;
    const sessionId = li.getAttribute('data-session-id');
    if (sessionId) {
      window.location.href = `/chat/session/${sessionId}`;
    }
  });

}



  // =======================
  // 👤 Mostrar / ocultar menú de perfil
  // =======================
  const profile = document.querySelector(".profile");
  const profileMenu = document.getElementById("profileMenu");

  if (profile && profileMenu) {
    profile.addEventListener("click", (e) => {
      e.stopPropagation();
      profileMenu.style.display = profileMenu.style.display === "flex" ? "none" : "flex";
    });

    window.addEventListener("click", (e) => {
      if (!profile.contains(e.target) && !profileMenu.contains(e.target)) {
        profileMenu.style.display = "none";
      }
    });
  }

  // =======================
  // 🧠 Ir a la Memoria
  // =======================
  const memoriaBtn = document.getElementById("memoriaBtn");
  if (memoriaBtn) {
    memoriaBtn.addEventListener("click", (e) => {
      e.preventDefault();
      window.location.href = "/memory";  // Cambia a "/memoria" si tu ruta es esa
    });
  }

  // =======================
  // 🚪 Cerrar sesión
  // =======================
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      try {
        const res = await fetch("/logout", { method: "POST" });
        if (res.redirected) {
          window.location.href = res.url;
        } else {
          const data = await res.json();
          if (data.success) {
            window.location.href = "/login";
          } else {
            alert("No se pudo cerrar sesión.");
          }
        }
      } catch (err) {
        alert("Error de red al cerrar sesión.");
      }
    });
  }

  // =======================
  // ✏️ Renombrar chat
  // =======================
  document.querySelectorAll('.rename-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const sessionId = btn.getAttribute('data-session-id');
      const newName = prompt("Nuevo nombre para el chat:");
      if (newName) {
        const resp = await fetch(`/chat/session/${sessionId}/rename`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `name=${encodeURIComponent(newName)}`
        });
        const data = await resp.json();
        if (data.success) {
          const titleEl = btn.closest('.chat-item')?.querySelector('.chat-title');
          if (titleEl) titleEl.textContent = data.name;
        } else {
          alert("Error: " + (data.error || "desconocido"));
        }
      }
    });
  });

  // =======================
  // 🗑️ Eliminar chat
  // =======================
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!confirm("¿Eliminar este chat?")) return;
      const sessionId = btn.getAttribute('data-session-id');
      const resp = await fetch(`/chat/session/${sessionId}/delete`, { method: 'POST' });
      const data = await resp.json();
      if (data.success) {
        btn.closest('.chat-item')?.remove();
      } else {
        alert("Error al eliminar chat");
      }
    });
  });

  // =======================
  // ⋮ Menú de acciones de chat (.chat-dots)
  // =======================
  document.querySelectorAll('.chat-dots').forEach(dots => {
    dots.addEventListener('click', (e) => {
      e.stopPropagation();
      const item = dots.closest('.chat-item');

      // Cierra otros
      document.querySelectorAll('.chat-item.active').forEach(i => {
        if (i !== item) i.classList.remove('active');
      });

      // Alterna este
      if (item) item.classList.toggle('active');
    });
  });

  // Cierra todos los menús si haces clic fuera
  window.addEventListener('click', (e) => {
    if (!e.target.closest('.chat-item')) {
      document.querySelectorAll('.chat-item.active').forEach(i => i.classList.remove('active'));
    }
  });

  // =======================
  // 📥 Colapsar/Expandir sidebar
  // =======================
  const sidebar = document.querySelector('.sidebar');
  const toggleBtn = document.querySelector('.toggle-menu-btn');
  if (sidebar && toggleBtn) {
    toggleBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sidebar.classList.toggle('collapsed');
      document.body.classList.toggle('sidebar-collapsed');
    });
  }



// =======================
// 📥 Redirigir al hacer clic en un chat-item
// =======================
document.querySelectorAll('.chat-item').forEach(item => {
  item.addEventListener('click', (e) => {
    // Evita que se dispare si estás haciendo clic en los íconos de editar/eliminar
    if (e.target.closest('.rename-btn') || e.target.closest('.delete-btn') || e.target.closest('.chat-dots')) {
      return;
    }

    const sessionId = item.getAttribute('data-session-id');
    if (sessionId) {
      window.location.href = `/chat/session/${sessionId}`;
    }
  });
});

// =======================
// 📥 Responsive
// =======================
  const mobileToggleBtn = document.querySelector('.mobile-toggle-btn');
  const mainArea        = document.querySelector('.main');
  const mq              = window.matchMedia('(max-width: 770px)');

  function setupMobileHandlers() {
    // Solo registro handlers en responsive
    if (!mq.matches) return;

    // ——— BOTÓN MÓVIL (☰) ———
    mobileToggleBtn.addEventListener('click', e => {
      e.stopPropagation();
      sidebar.classList.toggle('show');
      sidebar.classList.remove('collapsed');
      document.body.classList.remove('sidebar-collapsed');
      mobileToggleBtn.classList.toggle('hidden', sidebar.classList.contains('show'));
    });

    // ——— BOTÓN TOGGLE DENTRO DEL SIDEBAR ———
    toggleBtn.addEventListener('click', e => {
      e.stopPropagation();
      // Como estamos en responsive, SOLO cerramos
      sidebar.classList.remove('show');
      mobileToggleBtn.classList.remove('hidden');
    });

    // ——— CLICK FUERA EN ÁREA PRINCIPAL ———
    mainArea.addEventListener('click', () => {
      if (sidebar.classList.contains('show')) {
        sidebar.classList.remove('show');
        mobileToggleBtn.classList.remove('hidden');
      }
    });
  }

  // Ejecutamos al inicio
  setupMobileHandlers();
  // Y volvemos a ejecutar si cambia el tamaño
  mq.addEventListener('change', setupMobileHandlers);

  // (el resto de tu código de mobileToggleBtn permanece igual)


    // --- 1. OBTENER ELEMENTOS DEL DOM ---
    const attachButton = document.getElementById('attachFileBtn');
    const filePreviewsContainer = document.getElementById('file-previews-container');
    const inputWrapper = document.querySelector('.input-wrapper');
    const dropZone = document.body;

    // --- 2. GESTIÓN DE LA LISTA DE ARCHIVOS ---
    let attachedFiles = []; // Array para almacenar todos los archivos

    // --- 3. Mapeo de extensiones a íconos SVG (puedes agregar más)
    const fileIcons = {
        'pdf': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="8" y1="13" x2="16" y2="13"></line><line x1="8" y1="17" x2="16" y2="17"></line><line x1="10" y1="9" x2="14" y2="9"></line></svg>`,
        'txt': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="10" y2="9"></line></svg>`,
        'jpg': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 8c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3z"></path><path d="M4 4h16v16H4V4z"></path><path d="M4 16l5-5 5 5 5-5"></path></svg>`,
        'png': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 8c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3z"></path><path d="M4 4h16v16H4V4z"></path><path d="M4 16l5-5 5 5 5-5"></path></svg>`,
        'default': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V9l-7-7z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>`
    };

    // --- 4. FUNCIONALIDAD DEL BOTÓN "ADJUNTAR ARCHIVO" ---
    attachButton.addEventListener('click', () => {
        fileInput.click();
    });

    // --- 5. FUNCIONALIDAD DE "ARRASTRAR Y SOLTAR" (DRAG & DROP) ---
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    dropZone.addEventListener('drop', (e) => {
        const droppedFiles = e.dataTransfer.files;
        if (droppedFiles.length > 0) {
            addFiles(droppedFiles);
        }
    }, false);

    // --- 6. MANEJAR ARCHIVOS (TANTO DEL BOTÓN COMO DEL DRAG & DROP) ---
    fileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files.length > 0) {
            addFiles(files);
            fileInput.value = ''; // Limpiamos el input para permitir subir los mismos archivos de nuevo
        }
    });
    
    // --- 7. FUNCIONES PRINCIPALES ---

    /**
     * Añade archivos a la lista global y actualiza la vista.
     * @param {FileList} newFiles La lista de archivos a agregar.
     */
    function addFiles(newFiles) {
        // Concatenar los nuevos archivos a la lista existente
        attachedFiles = [...attachedFiles, ...Array.from(newFiles)];
        renderPreviews();
    }

    /**
     * Elimina un archivo de la lista global por su nombre y actualiza la vista.
     * @param {string} fileName El nombre del archivo a eliminar.
     */
    function removeFile(fileName) {
        attachedFiles = attachedFiles.filter(file => file.name !== fileName);
        renderPreviews();
    }

    /**
     * Renderiza todas las vistas previas de los archivos en la lista global.
     */
    function renderPreviews() {
        filePreviewsContainer.innerHTML = '';
        
        if (attachedFiles.length > 0) {
            filePreviewsContainer.classList.add('active');
            
            attachedFiles.forEach((file) => {
                const previewElement = document.createElement('div');
                previewElement.className = 'file-preview';
                
                const ext = file.name.split('.').pop().toLowerCase();
                const icon = fileIcons[ext] || fileIcons.default;
                
                previewElement.innerHTML = `
                    <div class="file-icon">${icon}</div>
                    <span class="file-name">${file.name}</span>
                    <button class="remove-btn" type="button">×</button>
                `;
                
                filePreviewsContainer.appendChild(previewElement);
                
                const removeBtn = previewElement.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => {
                    removeFile(file.name);
                });
            });
        } else {
            filePreviewsContainer.classList.remove('active');
        }
    }
    
const inputArea = document.querySelector('.input-area');

// Esta función ajustará el ancho del contenedor
function adjustPreviewContainerWidth() {
  const parentWidth = inputArea.offsetWidth;
  filePreviewsContainer.style.maxWidth = `${parentWidth}px`;
}

// Llama a la función al cargar la página y al cambiar el tamaño de la ventana
window.addEventListener('load', adjustPreviewContainerWidth);
window.addEventListener('resize', adjustPreviewContainerWidth);

// Llama a la función cada vez que se añadan archivos
fileInput.addEventListener('change', () => {
  // Lógica para manejar la selección de archivos...
  
  // Después de manejar los archivos, ajusta el ancho
  adjustPreviewContainerWidth();
  });
</script>
</body>

</html>



